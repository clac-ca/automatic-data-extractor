# docker-compose.yml
#
# Quickstart: starts three containers â€” ADE, SQL Server, and Azurite (blob storage).
# ADE runs ade-api + ade-web + ade-worker in a single container.
# If you use external SQL/Storage (ADE_SQL_* / ADE_STORAGE_*), remove sql/azurite or use docker-compose.production.yml.
#
# Run (requires Docker + Docker Compose):
#   curl -LO https://raw.githubusercontent.com/clac-ca/automatic-data-extractor/main/docker-compose.yml \
#     && docker compose -f docker-compose.yml up
# Override via env vars or a .env file.
#
services:

  ade:
    image: ${ADE_IMAGE:-ghcr.io/clac-ca/automatic-data-extractor:latest}
    depends_on:
      - sql
      - azurite
    ports:
      - "8000:8000"
    environment:
      # SQL
      ADE_SQL_HOST: ${ADE_SQL_HOST:-sql}
      ADE_SQL_PORT: ${ADE_SQL_PORT:-1433}
      ADE_SQL_USER: ${ADE_SQL_USER:-sa}
      ADE_SQL_PASSWORD: ${ADE_SQL_PASSWORD:-YourStrong!Passw0rd}
      ADE_SQL_DATABASE: ${ADE_SQL_DATABASE:-ade}
      ADE_SQL_ENCRYPT: ${ADE_SQL_ENCRYPT:-yes}
      ADE_SQL_TRUST_SERVER_CERTIFICATE: ${ADE_SQL_TRUST_SERVER_CERTIFICATE:-yes}

      # Storage
      ADE_STORAGE_ACCOUNT_NAME: ${ADE_STORAGE_ACCOUNT_NAME:-devstoreaccount1}
      ADE_STORAGE_ACCOUNT_KEY: ${ADE_STORAGE_ACCOUNT_KEY:-Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==}
      ADE_STORAGE_BLOB_ENDPOINT: ${ADE_STORAGE_BLOB_ENDPOINT:-http://azurite:10000/devstoreaccount1}

      # If you prefer a full connection string, set ADE_STORAGE_CONNECTION_STRING.
      # ADE_STORAGE_CONNECTION_STRING: ...

      # API
      ADE_API_HOST: ${ADE_API_HOST:-0.0.0.0}
      ADE_API_PORT: ${ADE_API_PORT:-8000}
      ADE_API_IMPORT: ${ADE_API_IMPORT:-ade_api.main:app}

      # Worker
      ADE_WORKER_MODULE: ${ADE_WORKER_MODULE:-ade_worker}
    # Default command is `ade start` (ENTRYPOINT is `ade`, CMD is `start`)

  sql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
      MSSQL_SA_PASSWORD: ${ADE_SQL_PASSWORD:-YourStrong!Passw0rd}
    ports:
      - "1433:1433"
    volumes:
      - ./data/sql:/var/opt/mssql

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.35.0
    command: azurite-blob --silent --location /data --blobHost 0.0.0.0 --blobPort 10000
    environment:
      # Create the storage account if missing (Azurite supports custom accounts via AZURITE_ACCOUNTS)
      AZURITE_ACCOUNTS: ${ADE_STORAGE_ACCOUNT_NAME:-devstoreaccount1}:${ADE_STORAGE_ACCOUNT_KEY:-Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==}
    ports:
      - "10000:10000"
    volumes:
      - ./data/azurite:/data
