name: Repo Layout Guard

on:
  pull_request:
  push:
    branches:
      - development
      - main

jobs:
  verify-layout:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Validate standard repo layout
        shell: bash
        run: |
          set -euo pipefail

          required_paths=(
            "backend/pyproject.toml"
            "backend/uv.lock"
            "backend/src"
            "backend/src/ade_cli/main.py"
            "backend/src/ade_cli/root/app.py"
            "backend/src/ade_cli/root/commands/start.py"
            "backend/src/ade_cli/root/commands/stop.py"
            "backend/tests"
            "backend/data/.gitkeep"
            "frontend/package.json"
            "frontend/package-lock.json"
            "frontend/src"
            "frontend/public"
            "setup.sh"
            "setup.ps1"
          )

          for path in "${required_paths[@]}"; do
            if [[ ! -e "${path}" ]]; then
              echo "Missing required path: ${path}" >&2
              exit 1
            fi
          done

          forbidden_paths=(
            "Makefile"
            "backend/src/ade/cli.py"
            "backend/src/ade_api/cli.py"
            "backend/src/ade_worker/cli.py"
            "backend/src/ade_db/cli.py"
            "backend/src/ade_storage/cli.py"
            "backend/src/ade_cli/root.py"
          )

          for path in "${forbidden_paths[@]}"; do
            if [[ -e "${path}" ]]; then
              echo "Forbidden path exists: ${path}" >&2
              exit 1
            fi
          done

          echo "Repo layout guard passed."
