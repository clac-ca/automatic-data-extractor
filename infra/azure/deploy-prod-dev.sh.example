#!/usr/bin/env bash
set -euo pipefail

# Dependencies:
# - Azure CLI (az): https://learn.microsoft.com/cli/azure/install-azure-cli
# - PostgreSQL client (psql): https://www.postgresql.org/download/

require_command() {
  local command_name="$1"
  if ! command -v "$command_name" >/dev/null 2>&1; then
    echo "Required command not found: $command_name" >&2
    exit 1
  fi
}

require_env() {
  local variable_name="$1"
  if [ -z "${!variable_name:-}" ]; then
    echo "Missing required variable: $variable_name" >&2
    exit 1
  fi
}

require_command az
require_command psql

# Copy this file to deploy-prod-dev.sh and replace all <...> placeholders.
# This script always deploys production + development.

subscription_id="<SUBSCRIPTION_ID>"
resource_group_name="rg-ade-shared-canadacentral-001"
location="canadacentral"
deployment_name="ade-azure-production-and-development-$(date +%Y%m%d-%H%M%S)"

workload="ade"
instance="001"
virtual_network_address_prefix="10.80.0.0/16"
container_apps_subnet_address_prefix="10.80.0.0/23"

postgresql_version="18"
postgresql_sku_tier="Burstable"
postgresql_sku_name="Standard_B1ms"
postgresql_storage_size_gb="32"
postgresql_production_database_name="ade"
postgresql_development_database_name="ade_dev"
postgresql_allow_public_access_from_azure_services="true"
public_ipv4_allowlist='["<ADMIN_PUBLIC_IPV4>"]'

storage_account_sku_name="Standard_LRS"

access_control_group_name_prefix="ade"

production_container_app_image="ghcr.io/clac-ca/automatic-data-extractor:<PRODUCTION_TAG>"
production_container_app_public_web_url=""
production_container_app_secret_key="<ADE_SECRET_KEY>"
production_container_app_environment_overrides='{"ADE_LOG_LEVEL":"INFO","ADE_LOG_FORMAT":"json","ADE_AUTH_DISABLED":"false"}'
production_container_app_minimum_replicas="1"
production_container_app_maximum_replicas="1"

development_container_app_image="ghcr.io/clac-ca/automatic-data-extractor:<DEVELOPMENT_TAG>"
development_container_app_public_web_url=""
development_container_app_secret_key=""
development_container_app_environment_overrides='{"ADE_LOG_LEVEL":"DEBUG","ADE_LOG_FORMAT":"json","ADE_AUTH_DISABLED":"false"}'
development_container_app_minimum_replicas="0"
development_container_app_maximum_replicas="1"

postgresql_bootstrap_entra_admin_login="<POSTGRESQL_BOOTSTRAP_ENTRA_ADMIN_LOGIN>"
postgresql_bootstrap_entra_admin_object_id="<POSTGRESQL_BOOTSTRAP_ENTRA_ADMIN_OBJECT_ID>"
postgresql_bootstrap_entra_admin_type="User"

require_env postgresql_bootstrap_entra_admin_login
require_env postgresql_bootstrap_entra_admin_object_id
require_env postgresql_bootstrap_entra_admin_type

resource_group_owners_group_name="${access_control_group_name_prefix}-rg-owners"
resource_group_contributors_group_name="${access_control_group_name_prefix}-rg-contributors"
resource_group_readers_group_name="${access_control_group_name_prefix}-rg-readers"
container_apps_admins_group_name="${access_control_group_name_prefix}-ca-admins"
container_apps_operators_group_name="${access_control_group_name_prefix}-ca-operators"
container_apps_readers_group_name="${access_control_group_name_prefix}-ca-readers"
database_admins_group_name="${access_control_group_name_prefix}-db-admins"
database_readwrite_group_name="${access_control_group_name_prefix}-db-readwrite"
database_readonly_group_name="${access_control_group_name_prefix}-db-readonly"
storage_admins_group_name="${access_control_group_name_prefix}-st-admins"
storage_readwrite_group_name="${access_control_group_name_prefix}-st-readwrite"
storage_readonly_group_name="${access_control_group_name_prefix}-st-readonly"

mail_nickname_for_group() {
  local group_name="$1"
  local normalized
  local hash_suffix

  normalized="$(echo "$group_name" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9' | cut -c1-48)"
  if [ -z "$normalized" ]; then
    normalized="adegroup"
  fi

  hash_suffix="$(printf '%s' "$group_name" | cksum | awk '{print $1}')"
  printf '%s' "${normalized}${hash_suffix}" | cut -c1-64
}

get_or_create_group_object_id() {
  local group_name="$1"
  local object_id

  object_id="$(az ad group list --filter "displayName eq '$group_name'" --query '[0].id' -o tsv 2>/dev/null || true)"
  if [ -n "$object_id" ]; then
    echo "$object_id"
    return 0
  fi

  az ad group create \
    --display-name "$group_name" \
    --mail-nickname "$(mail_nickname_for_group "$group_name")" \
    --query id \
    -o tsv >/dev/null

  object_id="$(az ad group list --filter "displayName eq '$group_name'" --query '[0].id' -o tsv 2>/dev/null || true)"
  if [ -z "$object_id" ]; then
    echo "Failed to resolve object ID for group '$group_name'." >&2
    exit 1
  fi

  echo "$object_id"
}

wait_for_postgresql_ready() {
  local server_name="$1"
  local max_attempts=30
  local wait_seconds=20
  local attempt=1

  while true; do
    local state
    state="$(az postgres flexible-server show --subscription "$subscription_id" --resource-group "$resource_group_name" --name "$server_name" --query state -o tsv 2>/dev/null || true)"

    if [ "$state" = "Ready" ]; then
      return 0
    fi

    if [ "$attempt" -ge "$max_attempts" ]; then
      echo "PostgreSQL server '$server_name' did not reach Ready state (last state: ${state:-unknown})." >&2
      return 1
    fi

    echo "Waiting for PostgreSQL server '$server_name' to become Ready (attempt $attempt/$max_attempts, current: ${state:-unknown})..."
    sleep "$wait_seconds"
    attempt=$((attempt + 1))
  done
}

set_postgresql_entra_admin_with_retry() {
  local server_name="$1"
  local display_name="$2"
  local object_id="$3"
  local principal_type="$4"
  local max_attempts=20
  local wait_seconds=15
  local attempt=1

  while true; do
    if az postgres flexible-server microsoft-entra-admin create \
      --subscription "$subscription_id" \
      --resource-group "$resource_group_name" \
      --server-name "$server_name" \
      --display-name "$display_name" \
      --object-id "$object_id" \
      --type "$principal_type" \
      --only-show-errors >/dev/null 2>&1; then
      return 0
    fi

    if [ "$attempt" -ge "$max_attempts" ]; then
      echo "Failed to set PostgreSQL Entra admin '$display_name' after $max_attempts attempts." >&2
      return 1
    fi

    echo "Failed to set PostgreSQL Entra admin '$display_name' (attempt $attempt/$max_attempts); retrying in $wait_seconds seconds..."
    sleep "$wait_seconds"
    attempt=$((attempt + 1))
  done
}

get_deployment_output_value() {
  local query_path="$1"
  local value

  value="$(az deployment group show \
    --subscription "$subscription_id" \
    --resource-group "$resource_group_name" \
    --name "$deployment_name" \
    --query "properties.outputs.${query_path}" \
    -o tsv 2>/dev/null || true)"

  if [ "$value" = "null" ]; then
    echo ""
  else
    echo "$value"
  fi
}

az login
az account set --subscription "$subscription_id"
az group create --subscription "$subscription_id" --name "$resource_group_name" --location "$location" >/dev/null

resource_group_owners_group_object_id="$(get_or_create_group_object_id "$resource_group_owners_group_name")"
resource_group_contributors_group_object_id="$(get_or_create_group_object_id "$resource_group_contributors_group_name")"
resource_group_readers_group_object_id="$(get_or_create_group_object_id "$resource_group_readers_group_name")"
container_apps_admins_group_object_id="$(get_or_create_group_object_id "$container_apps_admins_group_name")"
container_apps_operators_group_object_id="$(get_or_create_group_object_id "$container_apps_operators_group_name")"
container_apps_readers_group_object_id="$(get_or_create_group_object_id "$container_apps_readers_group_name")"
database_admins_group_object_id="$(get_or_create_group_object_id "$database_admins_group_name")"
database_readwrite_group_object_id="$(get_or_create_group_object_id "$database_readwrite_group_name")"
database_readonly_group_object_id="$(get_or_create_group_object_id "$database_readonly_group_name")"
storage_admins_group_object_id="$(get_or_create_group_object_id "$storage_admins_group_name")"
storage_readwrite_group_object_id="$(get_or_create_group_object_id "$storage_readwrite_group_name")"
storage_readonly_group_object_id="$(get_or_create_group_object_id "$storage_readonly_group_name")"

az deployment group create \
  --subscription "$subscription_id" \
  --resource-group "$resource_group_name" \
  --name "$deployment_name" \
  --template-file infra/azure/main.bicep \
  --parameters \
    location="$location" \
    workload="$workload" \
    instance="$instance" \
    deployDevelopmentEnvironment=true \
    virtualNetworkAddressPrefix="$virtual_network_address_prefix" \
    containerAppsSubnetAddressPrefix="$container_apps_subnet_address_prefix" \
    postgresqlVersion="$postgresql_version" \
    postgresqlSkuTier="$postgresql_sku_tier" \
    postgresqlSkuName="$postgresql_sku_name" \
    postgresqlStorageSizeGb="$postgresql_storage_size_gb" \
    postgresqlProductionDatabaseName="$postgresql_production_database_name" \
    postgresqlDevelopmentDatabaseName="$postgresql_development_database_name" \
    postgresqlAllowPublicAccessFromAzureServices="$postgresql_allow_public_access_from_azure_services" \
    publicIpv4Allowlist="$public_ipv4_allowlist" \
    storageAccountSkuName="$storage_account_sku_name" \
    resourceGroupOwnersEntraGroupObjectId="$resource_group_owners_group_object_id" \
    resourceGroupContributorsEntraGroupObjectId="$resource_group_contributors_group_object_id" \
    resourceGroupReadersEntraGroupObjectId="$resource_group_readers_group_object_id" \
    containerAppsAdminsEntraGroupObjectId="$container_apps_admins_group_object_id" \
    containerAppsOperatorsEntraGroupObjectId="$container_apps_operators_group_object_id" \
    containerAppsReadersEntraGroupObjectId="$container_apps_readers_group_object_id" \
    databaseAdminsEntraGroupObjectId="$database_admins_group_object_id" \
    databaseReadWriteEntraGroupObjectId="$database_readwrite_group_object_id" \
    databaseReadOnlyEntraGroupObjectId="$database_readonly_group_object_id" \
    storageAdminsEntraGroupObjectId="$storage_admins_group_object_id" \
    storageReadWriteEntraGroupObjectId="$storage_readwrite_group_object_id" \
    storageReadOnlyEntraGroupObjectId="$storage_readonly_group_object_id" \
    productionContainerAppImage="$production_container_app_image" \
    productionContainerAppPublicWebUrl="$production_container_app_public_web_url" \
    productionContainerAppSecretKey="$production_container_app_secret_key" \
    productionContainerAppEnvironmentOverrides="$production_container_app_environment_overrides" \
    productionContainerAppMinimumReplicas="$production_container_app_minimum_replicas" \
    productionContainerAppMaximumReplicas="$production_container_app_maximum_replicas" \
    developmentContainerAppImage="$development_container_app_image" \
    developmentContainerAppPublicWebUrl="$development_container_app_public_web_url" \
    developmentContainerAppSecretKey="$development_container_app_secret_key" \
    developmentContainerAppEnvironmentOverrides="$development_container_app_environment_overrides" \
    developmentContainerAppMinimumReplicas="$development_container_app_minimum_replicas" \
    developmentContainerAppMaximumReplicas="$development_container_app_maximum_replicas"

postgresql_server_name="$(get_deployment_output_value postgresqlServerName.value)"
postgresql_server_fqdn="$(get_deployment_output_value postgresqlFullyQualifiedDomainName.value)"
production_container_app_name="$(get_deployment_output_value productionContainerAppName.value)"
production_container_app_object_id="$(get_deployment_output_value productionContainerAppPrincipalId.value)"
production_database_name="$(get_deployment_output_value postgresqlProductionDatabaseName.value)"
development_container_app_name="$(get_deployment_output_value developmentContainerAppName.value)"
development_container_app_object_id="$(get_deployment_output_value developmentContainerAppPrincipalId.value)"
development_database_name="$(get_deployment_output_value postgresqlDevelopmentDatabaseName.value)"

if [ -z "$postgresql_server_name" ] || [ -z "$postgresql_server_fqdn" ]; then
  echo "Missing PostgreSQL deployment outputs required for bootstrap." >&2
  exit 1
fi

wait_for_postgresql_ready "$postgresql_server_name"

set_postgresql_entra_admin_with_retry \
  "$postgresql_server_name" \
  "$postgresql_bootstrap_entra_admin_login" \
  "$postgresql_bootstrap_entra_admin_object_id" \
  "$postgresql_bootstrap_entra_admin_type"

POSTGRESQL_SERVER_FQDN="$postgresql_server_fqdn" \
POSTGRESQL_ENTRA_BOOTSTRAP_LOGIN="$postgresql_bootstrap_entra_admin_login" \
PRODUCTION_CONTAINER_APP_ROLE_NAME="$production_container_app_name" \
PRODUCTION_CONTAINER_APP_OBJECT_ID="$production_container_app_object_id" \
PRODUCTION_DATABASE_NAME="$production_database_name" \
DEPLOY_DEVELOPMENT_ENVIRONMENT="true" \
DEVELOPMENT_CONTAINER_APP_ROLE_NAME="$development_container_app_name" \
DEVELOPMENT_CONTAINER_APP_OBJECT_ID="$development_container_app_object_id" \
DEVELOPMENT_DATABASE_NAME="$development_database_name" \
DATABASE_READWRITE_ROLE_NAME="$database_readwrite_group_name" \
DATABASE_READWRITE_OBJECT_ID="$database_readwrite_group_object_id" \
DATABASE_READONLY_ROLE_NAME="$database_readonly_group_name" \
DATABASE_READONLY_OBJECT_ID="$database_readonly_group_object_id" \
bash infra/azure/scripts/postgresql-entra-bootstrap.sh

set_postgresql_entra_admin_with_retry \
  "$postgresql_server_name" \
  "$database_admins_group_name" \
  "$database_admins_group_object_id" \
  Group

echo "Production + development deployment complete: $deployment_name"
