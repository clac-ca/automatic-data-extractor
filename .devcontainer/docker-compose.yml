version: "3.8"

services:
  ade:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    command: sleep infinity
    working_dir: /workspaces/automatic-data-extractor
    volumes:
      - ..:/workspaces/automatic-data-extractor:cached
    env_file:
      - ../.env
    depends_on:
      - sql
      - azurite

  sql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    # One consistent design across platforms:
    platform: linux/amd64
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
      MSSQL_SA_PASSWORD: "${MSSQL_SA_PASSWORD}"
    ports:
      - "1433:1433"
    volumes:
      - ../data/sql:/var/opt/mssql
    healthcheck:
      # Simple TCP check (SQL may take longer to accept logins; use scripts/db/wait-for-sql.sh for readiness)
      test: ["CMD-SHELL", "bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/1433'"]
      interval: 5s
      timeout: 3s
      retries: 40

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.35.0
    command: >
      azurite-blob
      --silent
      --location /data
      --blobHost 0.0.0.0
      --blobPort 10000
    ports:
      - "10000:10000"
    volumes:
      - ../data/azurite:/data
