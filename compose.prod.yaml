# compose.prod.yaml
#
# Local "prod-like" run:
# - SQL + Azurite local (dev-only)
# - API + Worker run from the SAME built image (single artifact)
#
# Build:
#   IMAGE_TAG=ade-app:local bash scripts/docker/build.sh
#
# Run:
#   IMAGE_TAG=ade-app:local docker compose -f compose.prod.yaml up
#

services:
  sql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
      MSSQL_SA_PASSWORD: ${ADE_SQL_PASSWORD:-YourStrong!Passw0rd}
    ports:
      - "1433:1433"
    volumes:
      - ./data/sql:/var/opt/mssql

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.35.0
    command: azurite-blob --silent --location /data --blobHost 0.0.0.0 --blobPort 10000
    environment:
      AZURITE_ACCOUNTS: ${ADE_STORAGE_ACCOUNT_NAME:-devstoreaccount1}:${ADE_STORAGE_ACCOUNT_KEY:-Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==}
    ports:
      - "10000:10000"
    volumes:
      - ./data/azurite:/data

  api:
    image: ${IMAGE_TAG:-ade-app:local}
    env_file: .env
    depends_on:
      - sql
      - azurite
    ports:
      - "8000:8000"
    command: ["api"]

  worker:
    image: ${IMAGE_TAG:-ade-app:local}
    env_file: .env
    depends_on:
      - sql
      - azurite
    command: ["worker"]
