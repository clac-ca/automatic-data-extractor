# CURRENT_TASK.md — Align the API contract with implemented authentication and pagination

## Snapshot of the current backend
- `Settings.auth_mode_sequence` only recognises `none`, `basic`, and `sso`; `none` must be the sole value and short-circuits auth. 【F:backend/app/config.py†L58-L132】
- `get_current_user()` prefers the session cookie, then HTTP Basic credentials, then SSO Bearer tokens, and falls back to an open-access admin identity when `auth_mode_sequence == ("none",)`. It always sets `WWW-Authenticate` based on the enabled modes. 【F:backend/app/auth/dependencies.py†L20-L126】
- All routers except `/health` depend on `get_current_user`, so the API is authenticated by default. `/health` performs a DB heartbeat and is already public. 【F:backend/app/main.py†L49-L64】【F:backend/app/routes/health.py†L13-L24】
- Error responses are raised with `HTTPException` and return a mix of plain strings or ad-hoc dicts. 【F:backend/app/routes/documents.py†L52-L109】【F:backend/app/routes/jobs.py†L40-L121】
- List endpoints accept `limit`/`offset` but most return bare lists; only the event timelines wrap results with `total`, `limit`, and `offset`. 【F:backend/app/routes/jobs.py†L83-L108】【F:backend/app/routes/events.py†L48-L88】【F:backend/app/schemas.py†L200-L226】
- There is no custom OpenAPI builder, so FastAPI’s autogenerated schema omits the security schemes, error envelopes, and pagination metadata we want to publish. 【F:backend/app/main.py†L40-L64】

## Objective
Publish an explicit OpenAPI 3.1 specification and docs that describe ADE’s real authentication flows, standardise error payloads, and give clients consistent pagination metadata — without rewriting domain services.

## Implementation plan

### 1. Curate the OpenAPI document
- Add `backend/app/openapi.py` with a `build_openapi(app, settings)` helper that calls `get_openapi()` and injects:
  - API info (title, description, version), tags, servers, and `externalDocs` linking to ADE docs.
  - `components.securitySchemes` describing HTTP Basic and Bearer SSO; note cookie sessions in the descriptions.
  - Reusable `components.responses` and `components.schemas` for the Problem Details structure and pagination envelope.
  - Shared `components.parameters` for `limit` / `offset` plus entity filters used by events.
  - Examples for representative success and error responses.
- In `backend/app/main.py`, cache the generated schema by assigning `app.openapi = lambda: build_openapi(app, config.get_settings())`.
- When `settings.auth_mode_sequence == ("none",)`, leave the top-level `security` empty; otherwise require either Basic or Bearer: `[{"basicAuth": []}, {"bearerAuth": []}]`.
- Mark `/health` as public with `openapi_extra={"security": []}` and add a `Cache-Control: no-store` header on the response.
- Export the rendered schema to `build/openapi/openapi.json` (checked in) and add a simple validation script (e.g. `scripts/check-openapi.sh`) that runs `openapi-spec-validator` and a `spectral` ruleset.

### 2. Standardise errors on Problem Details
- Create `backend/app/problem_details.py` with a `ProblemDetail` Pydantic model (`type`, `title`, `status`, `detail`, `instance`, plus ADE extensions like `code`, optional `errors`, `trace_id`).
- Provide a `problem(status, code, title, detail=None, *, type_url=None, instance=None, headers=None, **extra)` helper that returns `JSONResponse` with media type `application/problem+json` and forwards optional headers (so 401 responses still include `WWW-Authenticate`).
- Replace `HTTPException` usage in `backend/app/routes/{auth,configurations,documents,events,jobs}.py` with calls to `problem()`, mapping domain exceptions to stable ADE problem codes (e.g. `documents.not_found`, `jobs.invalid_status`). Ensure login failures continue to emit the correct `WWW-Authenticate` header and the auth event hooks stay untouched.
- Update FastAPI exception handlers if needed so uncaught `HTTPException` or validation errors are normalised to the new shape.

### 3. Unify pagination envelopes
- Add shared pagination models to `backend/app/schemas.py` (e.g. `PageInfo` and `Paginated[T]`) and a dependency such as `parse_pagination()` in a new `backend/app/pagination.py`.
- Update list endpoints to return the envelope:
  - `/jobs`, `/documents`, `/configurations` → `{ "items": [...], "page": { "limit": ..., "offset": ..., "total": ... } }`.
  - Event timelines already expose totals; migrate them to the shared models so all pagination metadata aligns.
  - `GET /documents/{id}/jobs` can expose history counts via the same structure (or document why it is intentionally different).
- Document the new response models in OpenAPI components and reuse shared parameter definitions (`limit`, `offset`, filters).

### 4. Documentation and regression coverage
- Refresh `docs/security/authentication-modes.md` to match the actual endpoints (`GET /auth/session` instead of the non-existent `/auth/refresh`, clarify mode fallbacks and open-access behaviour).
- Add `docs/reference/api.md` (or extend `docs/reference/README.md`) summarising auth schemes, error payload format, pagination contract, and pointing to the generated `openapi.json`.
- Add unit tests around the pagination helper and problem-details response factory; extend existing router tests (or add new ones) to assert the new envelope and error structure.
- Wire the OpenAPI validation script into CI (pytest invocation or `make openapi-check`) so the schema stays linted.

## Definition of done
- `GET /openapi.json` returns the curated schema with security schemes, shared components, and example payloads.
- All error responses from the routers use `application/problem+json` with ADE codes and preserve required headers (`WWW-Authenticate` on 401).
- List endpoints return the shared pagination envelope, and specs/tests cover the new structure.
- Docs in `docs/security/` and `docs/reference/` explain the delivered contract, and the OpenAPI validation script passes alongside the existing test suite.
