# ADE engine integration assessment

## Current runtime state
- The ADE engine orchestrates manifest loading, hook execution, extraction, scoring, and Excel output generation through `run_job`, wiring telemetry and writer hooks around the pipeline.【F:apps/ade-engine/src/ade_engine/worker.py†L19-L103】
- Extraction requires at least one staged input file in the job directory and will raise if `jobs/<job_id>/input` is empty.【F:apps/ade-engine/src/ade_engine/pipeline/extract.py†L15-L135】
- Input ingestion currently supports CSV/XLSX files. When processing workbooks without overrides the extractor now iterates over every worksheet; callers can set `ADE_RUN_INPUT_SHEETS` (or the legacy `ADE_RUN_INPUT_SHEET`) via run options to target a specific subset.【F:apps/ade-engine/src/ade_engine/pipeline/io.py†L26-L85】【F:apps/ade-engine/src/ade_engine/job_service.py†L63-L99】【F:apps/ade-api/src/ade_api/features/runs/service.py†L160-L216】

## Integration progress
- Streaming runs now stage a referenced document into the job directory before spawning the engine whenever `input_document_id` is provided, so `/configs/{config_id}/runs` can launch against real inputs once callers pass the option.【F:apps/ade-api/src/ade_api/features/runs/service.py†L376-L442】
- Workspace job submissions stage the uploaded document, enqueue engine execution (foreground or FastAPI background task), and persist artifact/log/output URIs for download.【F:apps/ade-api/src/ade_api/features/jobs/service.py†L98-L174】
- The documents UI now polls submitted jobs, surfaces artifact/log/output download links, and lists generated files once the run completes.【F:apps/ade-web/src/screens/Workspace/sections/Documents/index.tsx†L1500-L1715】

## Remaining work to process real spreadsheets
- [x] **Enable document-backed runs from the Config Builder.** The workbench now offers a document picker and worksheet selector before triggering `/configs/{config_id}/runs`, and the console drawer surfaces artifact/log/output downloads once the run finishes.【F:apps/ade-web/src/screens/Workspace/sections/ConfigBuilder/workbench/Workbench.tsx†L619-L714】【F:apps/ade-web/src/screens/Workspace/sections/ConfigBuilder/workbench/components/BottomPanel.tsx†L1-L148】
- [x] **Guard runs and jobs behind an active config build (or auto-build on demand).** Run execution failures caused by missing active builds now return HTTP 409 for both streaming runs and workspace jobs so the UI can guide users to rebuild before retrying.【F:apps/ade-api/src/ade_api/features/runs/service.py†L88-L142】【F:apps/ade-api/src/ade_api/features/jobs/router.py†L1-L210】
- [x] **Expose engine artifacts, logs, and outputs for streamed runs.** New run-scoped download endpoints mirror the job APIs, and the builder console shows artifact/log/output links for the latest extraction run.【F:apps/ade-api/src/ade_api/features/runs/router.py†L1-L210】【F:apps/ade-api/src/ade_api/features/runs/service.py†L300-L442】【F:apps/ade-web/src/screens/Workspace/sections/ConfigBuilder/workbench/components/BottomPanel.tsx†L1-L148】
- [x] **Add sheet/advanced input selection.** Worksheet metadata can be listed per document, the run drawer exposes a worksheet dropdown, and the engine honors the selected sheet when ingesting XLSX files.【F:apps/ade-engine/src/ade_engine/pipeline/io.py†L13-L48】【F:apps/ade-engine/src/ade_engine/pipeline/extract.py†L19-L70】【F:apps/ade-web/src/screens/Workspace/sections/Documents/index.tsx†L1500-L1715】【F:apps/ade-api/src/ade_api/features/documents/router.py†L1-L210】
- [x] **Persist streaming run input metadata.** Run rows now capture the staged document ULID and selected worksheet so API clients can audit which spreadsheet powered a streamed run, and the resource schema exposes the same fields in responses.【F:apps/ade-api/migrations/versions/0004_run_input_metadata.py†L1-L38】【F:apps/ade-api/src/ade_api/features/runs/models.py†L29-L80】【F:apps/ade-api/src/ade_api/features/runs/service.py†L133-L210】
- [x] **Update documents when streaming runs use them.** `_stage_input_document` now mirrors the job service by stamping `document.last_run_at` whenever a streaming run stages a file, ensuring the Documents UI reflects the most recent builder-triggered extraction.【F:apps/ade-api/src/ade_api/features/runs/service.py†L471-L508】【F:apps/ade-api/src/ade_api/features/jobs/service.py†L124-L167】
- [x] **Exercise full engine execution in integration tests.** A new end-to-end test provisions a real ADE runtime, seeds a CSV document, streams a run without safe mode, and asserts that logs, outputs, and document recency updates are emitted so regressions are caught automatically.【F:apps/ade-api/tests/integration/runs/test_runs_router.py†L1-L229】
- [x] **Surface streamed-run history inside the Documents experience.** The document service now merges the latest job-backed run with the latest streamed run (`Run.input_document_id`) per document so builder-triggered extractions populate `last_run` with run IDs, status, timestamps, and messages that appear in the Documents UI.【F:apps/ade-api/src/ade_api/features/documents/service.py†L232-L305】
- [x] **Add end-to-end coverage for worksheet overrides.** A new integration test seeds a multi-sheet XLSX, selects a non-active worksheet via `input_sheet_name`, and asserts the normalized output contains only the chosen sheet's rows, safeguarding the worksheet selector in the builder and document run drawer.【F:apps/ade-api/tests/integration/runs/test_runs_router.py†L301-L379】【F:apps/ade-web/src/screens/Workspace/sections/Documents/index.tsx†L1423-L1563】
- [x] **Expose a safe mode control path once the runtime is production-ready.** Safe mode can now be toggled via `/system/safe-mode`, persists its message across restarts, propagates to health checks and run execution, and administrators can enable or disable it from the workspace settings UI without redeploying.【F:apps/ade-api/src/ade_api/features/system_settings/router.py†L1-L70】【F:apps/ade-api/src/ade_api/features/runs/service.py†L244-L344】【F:apps/ade-web/src/shared/system/api.ts†L1-L63】【F:apps/ade-web/src/screens/Workspace/sections/Settings/components/SafeModeControls.tsx†L1-L119】
- [x] **Remember worksheet selections per document.** Run preferences now persist the chosen worksheet alongside the configuration/version, and the run drawer restores prior selections when reopened.【F:apps/ade-web/src/screens/Workspace/sections/Documents/index.tsx†L645-L672】【F:apps/ade-web/src/screens/Workspace/sections/Documents/index.tsx†L1500-L1715】
- [x] **Refactor the engine to process all worksheets by default.** The extractor now enumerates every worksheet in staged XLSX inputs when no override is provided, emitting a consolidated export that contains normalized rows for each sheet in the workbook.【F:apps/ade-engine/src/ade_engine/pipeline/io.py†L28-L85】【F:apps/ade-engine/src/ade_engine/pipeline/extract.py†L30-L121】【F:apps/ade-engine/tests/pipeline/test_io.py†L43-L87】
- [x] **Allow narrowing runs to a subset of worksheets.** The run drawer and config builder now default to processing every worksheet while offering checkbox-based multi-selects to narrow the scope, and the client run helpers emit `input_sheet_names` so the engine skips unselected sheets when a list is provided.【F:apps/ade-web/src/screens/Workspace/sections/Documents/index.tsx†L1458-L1711】【F:apps/ade-web/src/screens/Workspace/sections/ConfigBuilder/workbench/Workbench.tsx†L1695-L1902】【F:apps/ade-web/src/shared/runs/api.ts†L10-L44】
- [x] **Add API + persistence support for multi-sheet selection.** Runs now capture `input_sheet_names` across the create options, persisted model, and response schema—retaining the single `input_sheet_name` for backward compatibility—so multi-sheet requests can be audited as the engine refactor lands.【F:apps/ade-api/src/ade_api/features/runs/schemas.py†L40-L75】【F:apps/ade-api/src/ade_api/features/runs/models.py†L1-L90】【F:apps/ade-api/src/ade_api/features/runs/service.py†L167-L232】
- [x] **Harden integration coverage for multi-sheet runs.** Integration tests now seed multi-tab XLSX inputs to cover both the default all-sheet execution path and the narrowed worksheet list path, ensuring the refactored engine behavior remains stable.【F:apps/ade-api/tests/integration/runs/test_runs_router.py†L435-L584】
