# Bootstrap Azure Launch Infra (CAF Naming, PostgreSQL 18.1, Optional Dev)

## Goal

Create launch-ready Azure infrastructure for ADE with:

- one VNet-integrated Azure Container Apps environment
- one shared PostgreSQL Flexible Server (`Burstable`, `B1ms`, `1 vCore`, `2 GiB`, `32 GiB storage`)
- one shared Storage Account (Blob + Azure Files)
- one required prod app (`api,worker,web`)
- one optional dev app (`api,worker,web`)

This workflow intentionally uses **public PostgreSQL** with an Azure-services firewall rule for Fabric no-gateway mirroring compatibility. It does **not** create private endpoints.

## Script and Config Template

```bash
scripts/azure/bootstrap_launch_infra.sh
scripts/azure/bootstrap_launch_infra.env.example
```

## Prerequisites

- `az` (Azure CLI)
- `psql` (PostgreSQL client)
- `curl`
- Azure login with rights on the target subscription

The script auto-installs or updates the Azure CLI `containerapp` extension.

## Preflight Commands

```bash
command -v az curl psql
az --version
psql --version
az login
az account set --subscription "<SUBSCRIPTION_ID>"
az account show --query "{name:name,id:id,tenantId:tenantId}" -o table
```

## Default Naming Convention

When explicit names are not provided, the script generates names from:

- `NAME_STEM` (default: `automaticdataextractor`)
- `NAME_SUFFIX` (optional)
- `LOCATION` token

Generated defaults:

- `RESOURCE_GROUP`: `rg-<stem>[-<suffix>]`
- `POSTGRES_SERVER_NAME`: `psql-<stem>-<location>[-<suffix>]`
- `STORAGE_ACCOUNT_NAME`: `sa<stemnosymbols><suffixnosymbols>`
- `VNET_NAME`: `vnet-<stem>[-<suffix>]`
- `ACA_SUBNET_NAME`: `snet-<stem>-aca[-<suffix>]`
- `ACA_ENV_NAME`: `cae-<stem>-<location>[-<suffix>]`
- `PROD_APP_NAME`: `ca-<stem>-prod[-<suffix>]`
- `DEV_APP_NAME`: `ca-<stem>-dev[-<suffix>]` (only when `DEPLOY_DEV=true`)
- `PROD_STORAGE_MOUNT_NAME`: `share-<stem>-prod[-<suffix>]`
- `DEV_STORAGE_MOUNT_NAME`: `share-<stem>-dev[-<suffix>]` (only when `DEPLOY_DEV=true`)

Notes:

- Names generated by default are normalized to lowercase.
- Resource-specific validation still applies.
- Storage account prefix is intentionally `sa` per operator preference.
- CAF documentation commonly uses `st` for storage account abbreviation.

## PostgreSQL 18.1 Default and Enforcement

- Default `POSTGRES_VERSION` is `18.1`.
- Script accepts `major` (`18`) or `major.minor` (`18.1`).
- Create call uses major only (`az postgres flexible-server create --version 18`) because Azure CLI create accepts major.
- After server creation/update, script runs `SHOW server_version;` via SQL.
- If you requested a minor (`18.1`), script enforces strict prefix match (for example `18.1.x` is accepted, `18.0` or `17.x` fails).
- If you requested major only (`18`), script enforces major match only.

## Dev Optional Mode

### `DEPLOY_DEV=true` (default)

The script creates both prod and dev resources, including:

- dev DB (`POSTGRES_DEV_DB`)
- dev blob container / file share
- dev container app and scale checks
- dev DB role mapping and grants

### `DEPLOY_DEV=false`

The script provisions prod-only resources and skips:

- dev DB creation
- dev storage artifacts
- dev app deployment and verification
- dev principal mapping/grants

Dev-only inputs (`DEV_WEB_URL`, `DEV_SECRET_KEY`, etc.) are not required when dev is disabled.

## Quick Start

1. Copy and edit the template:

```bash
cp scripts/azure/bootstrap_launch_infra.env.example ./bootstrap_launch_infra.env
```

2. Run bootstrap:

```bash
bash scripts/azure/bootstrap_launch_infra.sh --env-file ./bootstrap_launch_infra.env
```

3. Optional prod-only run:

```bash
bash scripts/azure/bootstrap_launch_infra.sh --env-file ./bootstrap_launch_infra.env --deploy-dev false
```

## Validation Checklist

Built-in checks (`VERIFY_DEPLOYMENT=true` by default):

- prod health/info endpoint checks
- replica configuration checks
- storage firewall default action check
- PostgreSQL Azure-services rule check (when enabled)
- managed identity DB auth env checks
- PostgreSQL runtime version check against `POSTGRES_VERSION`

Manual checks:

1. Upload, run, and output download in prod app UI.
2. If `DEPLOY_DEV=true`: upload, run, and output download in dev app UI.
3. If `DEPLOY_DEV=true`: confirm dev app scales to zero when idle.
4. Confirm Fabric mirroring connectivity to PostgreSQL.

## Related References

- [Production Bootstrap](../tutorials/production-bootstrap.md)
- [Deploy to Production](deploy-production.md)
- [Run Migrations and Resets](run-migrations-and-resets.md)
- [Environment Variables](../reference/environment-variables.md)
